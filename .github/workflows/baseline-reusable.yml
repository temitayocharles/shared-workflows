name: Baseline Reusable

on:
  workflow_call:

permissions:
  contents: read

jobs:
  baseline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect repository content
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if git ls-files '*.tf' | grep -q .; then echo "has_tf=true" >> "$GITHUB_OUTPUT"; else echo "has_tf=false" >> "$GITHUB_OUTPUT"; fi
          if git ls-files '*.py' | grep -q .; then echo "has_py=true" >> "$GITHUB_OUTPUT"; else echo "has_py=false" >> "$GITHUB_OUTPUT"; fi
          if git ls-files '*.sh' | grep -q .; then echo "has_sh=true" >> "$GITHUB_OUTPUT"; else echo "has_sh=false" >> "$GITHUB_OUTPUT"; fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install validator deps
        run: python -m pip install --upgrade pip pyyaml

      - name: Validate YAML/JSON (non-blocking parse report)
        run: |
          python - <<"PY"
          import json
          from pathlib import Path
          import yaml

          issues = []
          for p in Path('.').rglob('*'):
            if not p.is_file() or '.git' in p.parts:
              continue
            try:
              if p.suffix in {'.yml', '.yaml'}:
                with p.open('r', encoding='utf-8') as f:
                  list(yaml.safe_load_all(f))
              elif p.suffix == '.json':
                with p.open('r', encoding='utf-8') as f:
                  json.load(f)
            except Exception as e:
              issues.append(f"{p}: {e}")

          if issues:
            print('WARN: parse issues detected:')
            for i in issues[:200]:
              print('-', i)
          print('validation complete')
          PY

      - name: Setup Terraform
        if: steps.detect.outputs.has_tf == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      - name: Terraform fmt check (advisory)
        if: steps.detect.outputs.has_tf == 'true'
        run: terraform fmt -check -recursive || true

      - name: Terraform validate (best effort, bounded)
        if: steps.detect.outputs.has_tf == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t dirs < <(git ls-files '*.tf' | xargs -n1 dirname | sort -u)
          dirs=("${dirs[@]:0:20}")
          for d in "${dirs[@]}"; do
            timeout 30s terraform -chdir="$d" init -backend=false >/dev/null || true
            timeout 30s terraform -chdir="$d" validate || true
          done

      - name: Python syntax validation
        if: steps.detect.outputs.has_py == 'true'
        run: python -m compileall -q .

      - name: Shell syntax validation (bash shebang only)
        if: steps.detect.outputs.has_sh == 'true'
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r f; do
            head -n1 "$f" | grep -Eq '^#!/.*bash' || continue
            bash -n "$f"
          done < <(git ls-files '*.sh')
